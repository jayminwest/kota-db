---
tags:
- file
- kota-db
- ext_yml
---
version: '3.8'

services:
  # KotaDB HTTP REST API Server
  kotadb:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kotadb-server
    restart: unless-stopped
    ports:
      - "${KOTADB_HTTP_PORT:-8080}:${KOTADB_HTTP_PORT:-8080}"
    environment:
      # HTTP server configuration
      - KOTADB_HTTP_PORT=${KOTADB_HTTP_PORT:-8080}
      - KOTADB_HTTP_HOST=${KOTADB_HTTP_HOST:-0.0.0.0}
      # Database configuration
      - KOTADB_DATA_DIR=${KOTADB_DATA_DIR:-/data}
      - KOTADB_CACHE_SIZE=${KOTADB_CACHE_SIZE:-1000}
      # Logging configuration
      - RUST_LOG=${RUST_LOG:-info}
      - RUST_BACKTRACE=${RUST_BACKTRACE:-0}
    volumes:
      # Persist database data
      - kotadb-data:${KOTADB_DATA_DIR:-/data}
      # Optional: Mount config file
      - ./kotadb.toml:/etc/kotadb/kotadb.toml:ro
    command: ["kotadb", "serve", "--port", "${KOTADB_HTTP_PORT:-8080}"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${KOTADB_HTTP_PORT:-8080}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - kotadb

  # Optional: Reverse proxy for production
  nginx:
    image: nginx:alpine
    container_name: kotadb-nginx
    restart: unless-stopped
    ports:
      - "${NGINX_PORT:-80}:80"
      - "${NGINX_SSL_PORT:-443}:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - kotadb
    networks:
      - kotadb
    profiles:
      - with-proxy

volumes:
  kotadb-data:

networks:
  kotadb:
    driver: bridge
