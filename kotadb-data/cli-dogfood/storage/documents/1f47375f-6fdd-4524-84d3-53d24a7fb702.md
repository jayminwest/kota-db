---
tags:
- file
- kota-db
- ext_py
---
#!/usr/bin/env python3
"""
Example: KotaDB Server Management

This example demonstrates how to automatically download, install, and manage
a KotaDB server instance using the Python client library.

The server management features make it trivial to get started with KotaDB
without manual compilation or installation.
"""

import time
from pathlib import Path
from kotadb import KotaDB, KotaDBServer, ensure_binary_installed, start_server


def example_1_basic_usage():
    """Basic server startup and usage."""
    print("=" * 60)
    print("Example 1: Basic Server Management")
    print("=" * 60)
    
    # Method 1: Using context manager (recommended)
    with KotaDBServer(port=8080) as server:
        print("Server is running...")
        
        # Connect client to the server
        client = KotaDB("http://localhost:8080")
        
        # Perform some operations
        doc_id = client.insert({
            "path": "/example/doc1.md",
            "title": "Test Document",
            "content": "This document was created with auto-managed server",
            "tags": ["example", "auto-server"]
        })
        print(f"Created document: {doc_id}")
        
        # Search for the document
        results = client.search("auto-managed")
        print(f"Found {len(results)} results")
    
    print("Server stopped automatically")


def example_2_manual_management():
    """Manual server lifecycle management."""
    print("\n" + "=" * 60)
    print("Example 2: Manual Server Management")
    print("=" * 60)
    
    # Create server instance
    server = KotaDBServer(
        port=8081,
        data_dir=Path("./kotadb_data")  # Custom data directory
    )
    
    try:
        # Start the server
        server.start()
        print(f"Server started on port 8081")
        print(f"Data directory: ./kotadb_data")
        
        # Check if running
        if server.is_running():
            print("‚úì Server is responsive")
        
        # Use the server
        client = KotaDB("http://localhost:8081")
        doc_id = client.insert({
            "path": "/manual/doc.md",
            "title": "Manual Management Example",
            "content": "Created with manually managed server"
        })
        print(f"Document created: {doc_id}")
        
    finally:
        # Always stop the server
        server.stop()
        print("Server stopped")


def example_3_convenience_function():
    """Using the convenience function for quick startup."""
    print("\n" + "=" * 60)
    print("Example 3: Convenience Function")
    print("=" * 60)
    
    # Quick start with convenience function
    server = start_server(port=8082)
    
    try:
        print("Server started with convenience function")
        
        # Use the server
        client = KotaDB("http://localhost:8082")
        
        # Batch insert example
        doc_ids = []
        for i in range(5):
            doc_id = client.insert({
                "path": f"/convenience/doc{i}.md",
                "title": f"Document {i}",
                "content": f"Content for document {i}",
                "tags": ["batch", "example"]
            })
            doc_ids.append(doc_id)
        
        print(f"Created {len(doc_ids)} documents")
        
        # List all documents
        docs = client.list()
        print(f"Total documents in database: {len(docs)}")
        
    finally:
        server.stop()


def example_4_binary_installation():
    """Demonstrate binary installation without starting server."""
    print("\n" + "=" * 60)
    print("Example 4: Binary Installation Only")
    print("=" * 60)
    
    # Ensure binary is installed (useful for CI/CD or containers)
    binary_path = ensure_binary_installed()
    print(f"KotaDB binary installed at: {binary_path}")
    
    # Check if binary exists
    if binary_path.exists():
        print("‚úì Binary verification successful")
        print(f"  Size: {binary_path.stat().st_size:,} bytes")
        print(f"  Executable: {binary_path.is_file() and binary_path.stat().st_mode & 0o111}")


def example_5_multiple_servers():
    """Run multiple KotaDB instances on different ports."""
    print("\n" + "=" * 60)
    print("Example 5: Multiple Server Instances")
    print("=" * 60)
    
    # Start multiple servers for different purposes
    servers = []
    
    try:
        # Development server
        dev_server = KotaDBServer(port=8090, data_dir=Path("./data/dev"))
        dev_server.start()
        servers.append(dev_server)
        print("Development server started on port 8090")
        
        # Test server
        test_server = KotaDBServer(port=8091, data_dir=Path("./data/test"))
        test_server.start()
        servers.append(test_server)
        print("Test server started on port 8091")
        
        # Connect to both
        dev_client = KotaDB("http://localhost:8090")
        test_client = KotaDB("http://localhost:8091")
        
        # Add data to each
        dev_client.insert({
            "path": "/dev/config.md",
            "title": "Development Config",
            "content": "Development environment configuration"
        })
        
        test_client.insert({
            "path": "/test/suite.md",
            "title": "Test Suite",
            "content": "Test suite documentation"
        })
        
        print("‚úì Both servers operational")
        
    finally:
        # Clean up all servers
        for server in servers:
            server.stop()
        print("All servers stopped")


def main():
    """Run all examples."""
    print("\n" + "üöÄ KotaDB Server Management Examples" + "\n")
    
    try:
        # Run each example
        example_1_basic_usage()
        example_2_manual_management()
        example_3_convenience_function()
        example_4_binary_installation()
        example_5_multiple_servers()
        
        print("\n" + "=" * 60)
        print("‚úÖ All examples completed successfully!")
        print("=" * 60)
        
    except Exception as e:
        print(f"\n‚ùå Error: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()